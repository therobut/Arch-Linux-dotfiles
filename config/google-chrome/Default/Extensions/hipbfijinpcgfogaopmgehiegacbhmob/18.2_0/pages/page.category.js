"use strict";(function(){var a=devhd.pkg("pages");var h=devhd.log.get("page.category");var f=devhd.i18n.L;a.CategoryPage=function(j){this.guid=j};var c=a.CategoryPage.prototype=new a.BasePage();c.service=function(k,j){this.loadTime=new Date().getTime();this.pageInfo=k;this.width=j.width;if(this.pageInfo.uri=="latest"){this.categoryLabel="#latest"}else{this.categoryLabel=this.pageInfo.key
}if(this.categoryLabel==null){h.error(39,"invalid category key: ",this.pageInfo.key,". Context: ",this.pageInfo.uri);this.categoryLabel="#latest"}this.title=devhd.utils.TermUtils.formatTitle(this.categoryLabel);this.initBase(j);this.startRenderHTML()};c.destroy=function(){this.waitingDisplayQueue=[];if(this.topArea!=null){this.topArea.destroy();this.topArea=null
}this.subscriptions=null;this.feedLocationIndex=null;this.displayedSubscriptionIndex=null;this.pageModel=null;this.c2e=null;if(this.controls!=null){for(var j=0;j<this.controls.length;j++){this.controls[j].destroy()}}this.controls=null;this.destroyBase()};c.allowsSearch=function(){return true};c.getSearchScope=function(){return devhd.utils.IdUtils.formatId("category",this.categoryLabel,this.home.getUserId())
};c.isLayoutAware=function(){return true};c.showCustomizer=function(j){this.showListCustomizer(j.target)};c.startRenderHTML=function(){var j=this;this.trends.askRankedSubscriptions(this.categoryLabel,this.hideReadArticlesFilter(),function(l,k){j.doRenderHTML(l,k)})};c.doRenderHTML=function(l,k){this._cancelAllVisualFinders();this.state="loading";this.subscriptions=k;
this.emptyMode=l.unreadCount==0;if(this.categoryLabel=="#latest"){this.subscriptions=this.subscriptions.slice(0,200)}this.pageModel=this.edito.buildExpandedCategoryPageModel(this.categoryLabel,this.subscriptions,this.width,this.hideReadArticlesFilter()&&!this.emptyMode);this.pageModel.header=[];this.feedly.setNbrPages(this.pageModel.nbrPages);var k=[];
for(var j=0;j<this.pageModel.parts.length;j++){k.push(this.pageModel.parts[j].subscription.id)}this.feedly.pushContext({uri:this.pageInfo.uri,pageNumber:this.pageModel.pageNumber,title:this.title,level:1,category:this.categoryLabel,subscriptions:[]});this.feedly.enableMarkAsRead();this.feedly.enableRefresh();this.feedly.setPageTitle(templates.page.category.title(l));
this.c2e={};if(this.pageModel.parts.length>0){this.pageElem.innerHTML=templates.page.category.layout(devhd.utils.TermUtils.formatTitle(this.categoryLabel),this.pageModel,this.width,this.home);this.element("aboutArea").innerHTML=templates.page.category.layoutAboutArea(devhd.utils.TermUtils.formatTitle(this.categoryLabel),this.pageModel,this.width,this.home);
this.element("aboutArea").style.display="block";if(this.getPreference("featuredArticles")=="yes"){var m=this;this.reco.askFeaturedEntries(devhd.utils.TermUtils.formatTerm(this.categoryLabel,this.home.getUserId(),"category"),{unreadOnly:true,n:3},function(n){m.continueRenderHTML(n,l.unreadCount)})}else{this.continueRenderHTML([],l.unreadCount)}}else{this.pageElem.innerHTML=templates.page.category.empty(devhd.utils.TermUtils.formatTitle(this.categoryLabel))
}};c.continueRenderHTML=function(o,j){if(this.isDestroyed()==true){return}o=(o||[]);this.headerIndex={};var n=this;var m=0;for(var l=0;l<o.length;l++){var k=o[l];if(k.getEngagement()>0||k.metadata.visual>0){m++}}if(o.length>0&&m>1){this.c2e["#featured"]=o;this.topArea=new devhd.control.RecommendationAreaControl();this.topArea.setHome(n.home);this.topArea.setReader(n.reader);
this.topArea.setFeatured(o);this.topArea.setPage(n);this.topArea.setPart(n.element("headline"));this.topArea.display();for(var l=0;l<o.length;l++){this.pageModel.header.push(o[l]);this.headerIndex[o[l].getId()]=true}}else{this.c2e["#featured"]=[];this.element("featuredArea").style.display="none"}this.element("latestArea").style.display="none";this.renderRestOfThePage()
};c.renderRestOfThePage=function(){this.createFeedLocationIndex();this.state="loaded";this.displayedSubscriptionIndex={};this.displayedSubscriptionCount=0;this.coreZoneStart=0;this.coreZoneEnd=0;this.pendingDisplayQueue={};this.pendingDisplayQueueSize=0;var j=this;if(this.requestedScrollTop==null){this.home.getDocument().defaultView.setTimeout(function(){j.lazyDisplay(0)
},0)}};c.createFeedLocationIndex=function(){this.feedLocationIndex=[];for(var k=0;k<this.pageModel.parts.length;k++){var j=this.pageModel.parts[k].subscription.id;var l=this.element("main_"+j);if(l==null){h.error(289,"failed to lookup element for: ",j);continue}this.feedLocationIndex.push({feedId:j,start:l.offsetTop,end:l.offsetTop+l.offsetHeight,part:this.pageModel.parts[k],element:l})
}};c.updateFeedLocationIndex=function(){for(var j=0;j<this.feedLocationIndex.length;j++){var k=this.feedLocationIndex[j];k.start=k.element.offsetTop;k.end=k.element.offsetTop+k.element.offsetHeight}};c.lookupFeedLocation=function(j){for(var k=0;k<this.feedLocationIndex.length;k++){if(this.feedLocationIndex[k].feedId==j){return this.feedLocationIndex[k]
}}h.error(327,"feed not found: ",j,". Hint: ",this.feedLocationIndex.length);return null};c.isFullyLoaded=function(){if(this.subscriptions==null){return false}return this.displayedSubscriptionCount==this.subscriptions.length};c.askLazyDisplay=function(j){if(this.isFullyLoaded()){return}if(this.coreZoneStart<j&&j<this.coreZoneEnd){return}if(this.lazyDisplayTimeout!=null){this.home.getDocument().defaultView.clearTimeout(this.lazyDisplayTimeout);
this.lazyDisplayTimeout=null}var k=this;this.lazyDisplayTimeout=this.home.getDocument().defaultView.setTimeout(function(){k.lazyDisplay(j)},i)};var i=250;var e=2.5;var g=0.25;var d=1000;c.lazyDisplay=function(n){if(this.isDestroyed()){return}if(this.feedLocationIndex==null){return}this.waitingDisplayQueue=[];this.updateFeedLocationIndex();this.coreZoneStart=n-g*d;
this.coreZoneEnd=n+d+g*d;var j=n-e*d;var k=n+d+e*d;for(var l=0;l<this.feedLocationIndex.length;l++){var m=this.feedLocationIndex[l];if(m.end<j){continue}if(m.start>k){break}if(b(m,this.coreZoneStart,this.coreZoneEnd)){this.scheduleDisplayFeed(m,0)}else{if(b(m,j,k)){this.scheduleDisplayFeed(m,1)}}}this.processDisplayWaitingQueue()};function b(l,j,k){return l.start>=j&&l.start<=k||l.end>=j&&l.end<=k||l.start<=j&&l.end>=k
}c.scheduleDisplayFeed=function(k,j){if(this.displayedSubscriptionIndex[k.feedId]!=null){return}if(this.pendingDisplayQueue[k.feedId]!=null){return}if(k.part.nbrEntries==0){this.pageModel.index[k.feedId].entries=[];this.displayedSubscriptionIndex[k.feedId]=true}this.element("main_"+k.feedId+"_entries").innerHTML=templates.page.category.loading(k.part.nbrEntries,j,this.home);
if(j==0){this.askDisplayFeed(k,j)}else{this.waitingDisplayQueue.push({fl:k,priority:j})}};c.processDisplayWaitingQueue=function(){if(this.pendingDisplayQueueSize>0){return}if(this.waitingDisplayQueue.length==0){return}var j=this;this.home.getDocument().defaultView.setTimeout(function(){j.doProcessDisplayWaitingQueue()},0)};c.doProcessDisplayWaitingQueue=function(){if(this.isDestroyed()){return
}if(this.pendingDisplayQueueSize>0){return}if(this.waitingDisplayQueue.length==0){return}var j=this.waitingDisplayQueue.shift();this.askDisplayFeed(j.fl,j.priority);this.processDisplayWaitingQueue()};c.askDisplayFeed=function(m,l){var k=m.feedId;var j=m.part.nbrEntries;this.pendingDisplayQueue[k]=true;this.pendingDisplayQueueSize++;this.askFeedEntries(k,j)
};c.onPageScrollChanged=function(j){this.askLazyDisplay(j)};c.askFeedEntries=function(k,j){if(this.reader==null){return}var l=this;this.reader.askEntries(k,{xt:(!this.emptyMode?"read":null)},j,function(m){if(l.isDestroyed()==true){return}try{l.onEntriesReady(k,m)}catch(n){h.error(511,"display articles",n)}},function(n,m){l.onEntriesError(k,n,m)})};c.determinePageNumber=function(j){if(j<=2){return 0
}else{return 1+Math.floor((j-2)/3)}};c.onEntriesReady=function(k,j){if(this.isDestroyed()||this.pageModel.index[k]==null){return}this.displayEntries(k,j)};c.onEntriesError=function(j,m,k){var l=this.element("main_"+j+"_entries");if(l!=null){l.innerHTML=m+" -- "+k}};c.displayEntries=function(k,p){try{if(p.length>0){var m=p[0];this.element("main_"+k+"_title").href=m.getSourceAlternateLink()
}var q=[];for(var o=0;o<p.length;o++){var v=p[o];if(this.headerIndex[v.getId()]!=null){continue}q.push(v)}p=q.slice(0,this.pageModel.index[k].nbrEntries).sort(function(y,x){return x.crawledTime-y.crawledTime});var n=[];this.pageModel.index[k].entries=[];var r=0;var w=p.length-3;if(w<4){w=4}for(var o=0;o<p.length;o++){var v=p[o];var t=this.pageModel.index[k].type;
if(t=="4"&&r>=w){t="12"}n.push({entry:v,type:t});r++;this.pageModel.index[k].entries.push(v)}this.c2e[k]=this.pageModel.index[k].entries;if(this.pageModel.index[k].entries.length>0){var u=this.element("main_"+k+"_entries");u.innerHTML=templates.page.base.parts(n,this.width,{includeFavIcon:true},this.home);u.style.height="auto";for(var o=0;o<n.length;
o++){if(n[o].type=="4"||n[o].type=="6"||n[o].type=="7"){this.askFindVisual(n[o].entry,"U"+n[o].type)}}this.askAdjustEntries(this.pageModel.index[k].entries)}else{var u=this.element("main_"+k);if(u!=null){u.style.display="none"}}this.updateFeedLocationIndex();this.pendingAskEntriesRequests--;this.displayedSubscriptionIndex[k]=true;this.displayedSubscriptionCount++;
if(this.requestedSelectedEntryId!=null&&this.selectedEntryId==null){for(var o=0;o<p.length;o++){if(p[o].getId()==this.requestedSelectedEntryId){this.selectEntry(this.requestedSelectedEntryId,false)}}}this.pendingDisplayQueue[k]=null;this.pendingDisplayQueueSize--;this.processDisplayWaitingQueue()}catch(s){var l=devhd.utils.ExceptionUtils.formatError("display articles",s);
h.error(656,"displayEntries ",s);var j=this.element("main_"+k+"_entries");j.innerHTML=l}};c.onSubscriptionAdded=function(k,j,l){if(l==true){return}this.feedly.reloadPage()};c.onSubscriptionRemoved=function(j){if(this.pageModel.index[j]==null){return}this.feedly.reloadPage({forceRecreate:false,disableAutoMarkAsRead:true})};c.markAsRead=function(j){var m=(j==null);
var k={};if(j!=null){k.asOf=j}var l=this;this.markCategoryAsRead(this.categoryLabel,k,false,function(){if(m){l.feedly.jumpToNext()}else{l.feedly.reloadPage({forceRecreate:true})}});this.popup.hide()};c.markAsReadOneDay=function(){this.markAsRead(new Date().getTime()-devhd.utils.DurationUtils.DAYS(1))};c.markAsReadOneWeek=function(){this.markAsRead(new Date().getTime()-devhd.utils.DurationUtils.DAYS(7))
};c.markPageAsRead=function(){this.signs.setMessage(f(87),100);var m=[];for(var l=0;l<n.pageModel.header.length;l++){m.push(n.pageModel.header[l].getId())}for(var l=0;l<n.pageModel.parts.length;l++){var o=n.pageModel.parts[l];if(o.entries!=null&&o.entries.length>0){for(var k=0;k<o.entries.length;k++){m.push(o.entries[k].getId())}}}var n=this;this.reader.askMarkEntriesAsRead(m,function(){},function(j){n.signs.setMessage("Error:"+j)
})};c.markSectionAsRead=function(m){var k=[];var n=this.c2e[m];for(var j=0;j<n.length;j++){k.push(n[j].getId())}var l=this;this.reader.askMarkEntriesAsRead(k,function(){},function(o){l.signs.setMessage("Error:"+o)})};c.onSubscriptionMarkedAsRead=function(j){if(this.pageModel.index[j]==null){return}this.unInlineEntry("none",false);for(var k=0;k<this.pageModel.parts.length;
k++){var l=this.pageModel.parts[k];if(l.entries!=null&&l.entries.length>0&&l.entries[0].getFeedId()==j){this.pageModel.parts.splice(k,1);break}}this.state="loaded"};c.onSubscriptionRemoved=function(j,l){if(l==true){return}if(this.pageModel.index[j]==null){return}for(var k=0;k<this.pageModel.parts.length;k++){var m=this.pageModel.parts[k];if(m.entries!=null&&m.entries.length>0&&m.entries[0].getFeedId()==j){this.pageModel.parts.splice(k,1);
break}this.pageModel.index[j]=null}this.effects.fade(this.element("main_"+j),{delay:1,from:1,to:0,onComplete:function(n){devhd.utils.HTMLUtils.remove(n)}},"feedly")};c.findNextEntryId=function(o){var n=false;if(this.selectedEntryId==null){n=true}for(var l=0;l<this.pageModel.header.length;l++){if(n==true){if(o==true){var k=this.pageModel.header[l];if(k.isRead()==false){return k.getId()
}else{continue}}else{return this.pageModel.header[l].getId()}}if(this.pageModel.header[l].getId()==this.selectedEntryId){n=true}}for(var m=0;m<this.pageModel.parts.length;m++){var p=this.pageModel.parts[m];if(p.entries!=null&&p.entries.length>0){for(var l=0;l<p.entries.length;l++){if(n==true){if(o==true){var k=p.entries[l];if(k.isRead()==false){return k.getId()
}else{continue}}else{return p.entries[l].getId()}}if(p.entries[l].getId()==this.selectedEntryId){n=true}}}}return null};c.onNextEntry=function(l,j){var k=this.findNextEntryId(l);if(k!=null){if(j==true){this.selectEntry(k,"toview")}else{this.inlineEntry(k,true,true)}}else{if(this.isFullyLoaded()==true){this.feedly.loadNextPage({selectEntry:true,navigationMode:"keyboard"})
}else{this.signs.setMessage(f(88))}}};c.findPreviousEntryId=function(n){var m=false;if(this.selectedEntryId==null){m=true}for(var l=this.pageModel.parts.length-1;l>=0;l--){var o=this.pageModel.parts[l];if(o.entries!=null&&o.entries.length>0){for(var k=o.entries.length-1;k>=0;k--){if(m==true){return o.entries[k].getId()}if(o.entries[k].getId()==this.selectedEntryId){m=true
}}}}for(var k=this.pageModel.header.length-1;k>=0;k--){if(m==true){return this.pageModel.header[k].getId()}if(this.pageModel.header[k].getId()==this.selectedEntryId){m=true}}};c.onPreviousEntry=function(l,j){var k=this.findPreviousEntryId(l);if(k!=null){if(j==true){this.selectEntry(k,"toview")}else{this.inlineEntry(k,true,true)}}else{this.feedly.loadPreviousPage({selectEntry:true,navigationMode:"keyboard"})
}}})();