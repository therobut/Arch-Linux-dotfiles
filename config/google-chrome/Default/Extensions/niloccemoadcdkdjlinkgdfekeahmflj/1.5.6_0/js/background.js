/* globals ril, isChrome, isOpera, isSafari, sendMessageToTab, broadcastMessageToAllTabs, executeScriptInTab, isValidURL, getAllTabs, addMessageListener, getSetting, setSetting, openTabWithURL, isGoogleReaderURL, executeScriptFromURLInTabWithCallback, getCurrentTab, isMac */
/* jslint vars: true */
var backgroundPage=function(){function i(e){sendMessageToTab(e,{status:"error",error:"Sorry, you can only save valid web pages to Pocket."})}function s(e,t,n,r){t&&(n==="save"?executeScriptInTab(e,"window.___PKT__URL_TO_SAVE = '"+t+"'"):n==="remove"&&executeScriptInTab(e,"window.___PKT__URL_TO_REMOVE = '"+t+"'")),executeScriptFromURLInTabWithCallback(e,"js/r.js",r)}function o(e,t){isChrome()?executeScriptFromURLInTabWithCallback(e,"vendor/Autocomplete/Autocomplete.js",t):t()}function u(e,t){if(isChrome()){var n="../img/"+t+"-19.png",r="../img/"+t+"-38.png";chrome.browserAction.setIcon({tabId:e,path:{19:n,38:r}})}}function a(e){u(e,"browser-action-icon")}function f(e){u(e,"browser-action-icon-added")}function l(e,t){typeof t!="undefined"&&t===!0&&f(e.id),sendMessageToTab(e,{status:"success"})}function c(e,t){var n=t.getResponseHeader("X-Error");n===null||typeof n=="undefined"?n="Pocket was unable to save the page. Please make sure that you are online, and try again.":n='Pocket could not save because "'+n+'"',sendMessageToTab(e,{status:"error",message:n})}var e=!1,t="1.5.6",n,r;Array.prototype.removeByValue=function(e){for(var t=0;t<this.length;t++)if(this[t]==e){this.splice(t,1);break}},n=function(){var e,t=function(t,n){e=n;if(isChrome()){var r=428,i=isOpera()?461:385;chrome.windows.create({url:"../html/login.html",type:"popup",width:r,height:i,left:Math.floor(screen.width/2-(r+1)/2),top:Math.floor(screen.height/2-i/2)},function(){})}else if(isSafari()){var s=t&&t.browserWindow?t.browserWindow:safari.application.activeBrowserWindow,o;if(s)for(var u=0;u<safari.extension.toolbarItems.length;u++)if(s===safari.extension.toolbarItems[u].browserWindow){o=safari.extension.toolbarItems[u];break}o=o||safari.extension.toolbarItems[0];if(!o.popover){var a=safari.extension.createPopover("com.ideashower.pocket.safari.login.popover",safari.extension.baseURI+"html/login.html",427,385);o.popover=a}o&&o.popover&&o.popover.contentWindow&&o.popover.contentWindow.reset&&o.popover.contentWindow.reset(),o.showPopover()}},n=function(t){broadcastMessageToAllTabs({action:"updateOptions"}),isSafari()&&safari.extension.popovers[0].hide(),e!==undefined?(e(),e=undefined):getCurrentTab(function(e){isValidURL(e.url)&&h(e,{url:e.url,actionInfo:{cxt_ui:"toolbar"}})}),u(),setTimeout(t,0)},r=function(e,t,r,i){ril.login(e,t,{success:function(){n(r)},error:i})},i=function(e,t){ril.loginViaCookie({success:function(){n(e)},error:t})},s=function(){ril.logout(),o()},o=function(){isChrome()&&getAllTabs(function(e){$.each(e,function(e,t){chrome.browserAction.setPopup({tabId:t.id,popup:"../html/login.html"})})})},u=function(){if(isChrome())getAllTabs(function(e){$.each(e,function(e,t){chrome.browserAction.setPopup({tabId:t.id,popup:""})})});else if(isSafari()){var e=safari.extension.toolbarItems;for(var t=0;t<e.length;t++){var n=e[t];n.idenfifier==="pocket"&&n.popover&&(n.popover=null),n.validate()}safari.extension.removePopover("com.ideashower.pocket.safari.login.popover")}};return addMessageListener(function(e,n,i){if(e.action==="login")return r(e.username,e.password,function(){i({status:"success"})},function(e){i({status:"error",error:e.getResponseHeader("X-Error")})}),!0;if(e.action==="logout")return s(),i({}),!1;if(e.action==="showLoginWindow")return t(undefined,function(){}),i({}),!1}),{showLoginWindow:t,login:r,loginViaCookie:i,logout:s,removeLoginPopupsForAllTabs:u}}(),r=function(){var e=[],t=[],n=function(r,i,s){isChrome()?s({injected:!0}):getSetting("pocket.restart")===!0||getSetting("pocket.restart")==="true"?s({injected:!0}):$.inArray(i,e)===-1?(e.push(i),r.page.dispatchMessage("isSafariContentAvailable",{url:i}),setTimeout(function(){n(r,i,s)},250)):$.inArray(i,e)!==-1&&$.inArray(i,t)===-1?(e.removeByValue(i),alert("Oops, This tab was open before you installed Pocket. Please restart Safari or refresh this page ("+String.fromCharCode("8984")+"R) in order to save it."),s({injected:!1})):(e.removeByValue(i),t.removeByValue(i),s({injected:!0}));if(isSafari()){safari.application.addEventListener("message",function(e){var n=e.name,r=e.message;n==="safariContentAvailable"&&t.push(r.url)});if(getSetting("pocket.run")!==!1&&getSetting("pocket.run")!=="false"||getSetting("pocket.restart")!==!1&&getSetting("pocket.restart")!=="false"){if(getSetting("pocket.run")===!1||getSetting("pocket.run")==="false")setSetting("pocket.restart",!0),setSetting("pocket.run",!0)}else setSetting("pocket.restart",!0)}};return{safariContentInjected:n}}(),addMessageListener(function d(e,t,u){var a,f;if(e.action==="getSetting")return u({value:getSetting(e.key)}),!1;if(e.action==="setSetting")return setSetting(e.key,e.value),broadcastMessageToAllTabs({action:"settingChanged",key:e.key,value:e.value}),u({}),!1;if(e.action==="isValidToken")return ril.isValidToken(function(e){u({value:e})}),!0;if(e.action==="openTab")return openTabWithURL(e.url),u({}),!1;if(e.action==="addURL")return a=e.url,f=e.title,ril.isAuthorized()?(r.safariContentInjected(t.tab,a,function(r){if(r.injected===!1){u({status:"error"});return}s(t.tab,a,"save",function(){if(!isValidURL(a)){i(t.tab),u({status:"error"});return}ril.add(f,a,{actionInfo:e.actionInfo,success:function(){l(t.tab,e.showSavedToolbarIcon),u({status:"success"})},error:function(r,i){if(r===401)return sendMessageToTab(t.tab,{status:"unauthorized"}),n.showLoginWindow(t.tab,function(){d(e,t,u)}),!1;c(t.tab,i)}})})}),!0):(n.showLoginWindow(t.tab,function(){d(e,t,u)}),!0);if(e.action==="getTags"){var h=function(){var e=getSetting("tags"),t="";e&&(t=JSON.parse(e));var n=getSetting("usedTags"),r=[];if(n){var i=JSON.parse(n),s=[];for(var o in i)s.push(i[o]);s.sort(function(e,t){return e=new Date(e.timestamp),t=new Date(t.timestamp),e<t?-1:e>t?1:0});for(var a=0;a<s.length;a++)r.push(s[a].tag);r.reverse()}u({value:{tags:t,usedTags:r}})};return o(t.tab,function(){ril.fetchTags({success:h,error:h})}),!0}if(e.action==="addTags"){if(!ril.isAuthorized())return n.showLoginWindow();var p=e.tags,v={action:"tags_add",tags:p,url:e.url,cxt_ui:"popover",cxt_url:t.tab.url};return ril.sendAction(v,{success:function(){var e=getSetting("usedTags"),t=e?JSON.parse(e):{};for(var n=0;n<p.length;n++){var r=p[n].trim(),i={tag:r,timestamp:new Date};t[r]=i}setSetting("usedTags",JSON.stringify(t)),u({status:"success"})},error:function(r,i){if(r===401)return sendMessageToTab(t.tab,{status:"unauthorized"}),n.showLoginWindow(t.tab,function(){d(e,t,u)}),!0;u({status:"error",error:i.getResponseHeader("X-Error")})}}),!0}});var h=function(e,t){var o=t.title||e.title||"",u=t.url||e.url||"",a=typeof t.showSavedIcon!="undefined"?t.showSavedIcon:!0;if(!ril.isAuthorized()){n.showLoginWindow(e,function(){h(e,t)});return}r.safariContentInjected(e,u,function(r){if(r.injected===!1)return;s(e,u,"save",function(){if(!isValidURL(u)){i(e);return}ril.add(o,u,{actionInfo:t.actionInfo,success:function(n){l(e,a),t.success&&t.success(n)},error:function(r,i){if(r===401){sendMessageToTab(e,{status:"unauthorized"}),n.showLoginWindow(e,function(){h(e,t)});return}c(e,i),t.error&&t.error(r,i)}})})})},p=function(e,t,n){s(e,t.given_url,"remove",function(){var r=t.item_id;ril.remove(r,{success:function(){a(e.id),sendMessageToTab(e,{status:"removed"}),n.success&&n.success()},error:function(e,t){n.error&&n.error(e,t)}})})};return function(){if(isChrome()){var t=function(e,t){var n=e.linkUrl,r=e.selectionText||n,i="right_click_link";n||(n=t.url,r=t.title,i="right_click_page"),h(t,{showSavedIcon:!1,url:n,title:r,actionInfo:{cxt_ui:"right_click",cxt_url:t.url}})};chrome.contextMenus.create({title:"Save to Pocket",contexts:["page","frame","editable","image","video","audio","link","selection"],onclick:t})}}(),function(){isSafari()&&safari.application.addEventListener("command",function(e){e.command==="handleSaveToPocketContextMenu"&&getCurrentTab(function(t){var n=e.userInfo,r="right_click";typeof n=="undefined"&&(n=t.url,r="right_click_page"),h(t,{url:n,actionInfo:{cxt_ui:r,cxt_url:t.url}})})},!1)}(),function(){if(isSafari()){safari.application.addEventListener("command",function(e){e.command==="handleSaveToPocketToolbar"&&getCurrentTab(function(e){h(e,{url:e.url,actionInfo:{cxt_ui:"toolbar"}})})},!1);return}var t=function(e){if(!ril.isAuthorized()){chrome.browserAction.setPopup({tabId:e,popup:"../html/login.html"});return}};chrome.browserAction.onClicked.addListener(function(e,t){h(e,{url:t,actionInfo:{cxt_ui:"toolbar"}})}),chrome.tabs.onUpdated.addListener(function(e,n,r){t(e)}),chrome.tabs.onActivated.addListener(function(e){t(e.tabId)})}(),function(){var r=t;$.each({twitter:"true",hackernews:"true",reddit:"true",yahoo:"true","keyboard-shortcut":"true","keyboard-shortcut-add":isMac()?String.fromCharCode("8984")+"+"+String.fromCharCode("8679")+"+P":"ctrl+shift+S"},function(e,t){getSetting(e)||setSetting(e,t)}),!isMac()&&getSetting("keyboard-shortcut-add").match("command")&&setSetting("keyboard-shortcut-add",getSetting("keyboard-shortcut-add").replace(/command/g,"ctrl")),getSetting("password")&&setSetting("password",undefined);if(getSetting("installed")!=="true")setSetting("installed","true"),openTabWithURL("http://getpocket.com/installed/");else if(e&&getSetting("installed")==="true"&&(!getSetting("lastInstalledVersion")||getSetting("lastInstalledVersion")!=r)){var i;isOpera()?i="opera":isChrome()?i="chrome":isSafari()&&(i="safari"),openTabWithURL("http://getpocket.com/"+i+"/updated?v="+r+"&vo="+getSetting("lastInstalledVersion"))}setSetting("lastInstalledVersion",r),isSafari()&&(safari.extension.settings.openSettingsSafariCheckbox=!1,safari.extension.settings.addEventListener("change",function(e){var t=e.key;if(t==="openSettingsSafariCheckbox"){var n=safari.application.activeBrowserWindow,r;n?r=n.openTab():r=safari.application.openBrowserWindow().activeTab,r.url=safari.extension.baseURI+"html/options.html",safari.application.activeBrowserWindow.activate()}}),safari.extension.addContentScriptFromURL(safari.extension.baseURI+"sites/twitter/twitter.ril.js",["http://twitter.com/*","https://twitter.com/*"],[],!0),safari.extension.addContentStyleSheetFromURL(safari.extension.baseURI+"sites/twitter/twitter.ril.css",["http://twitter.com/*","https://twitter.com/*"],[]),safari.extension.addContentScriptFromURL(safari.extension.baseURI+"sites/hackernews/hn.pocket.js",["http://*.ycombinator.org/*","https://*.ycombinator.org/*","http://*.ycombinator.com/*","https://*.ycombinator.com/*"],[],!0),safari.extension.addContentScriptFromURL(safari.extension.baseURI+"sites/reddit/reddit.pocket.js",["*://*.reddit.com/*"],[],!0),safari.extension.addContentScriptFromURL(safari.extension.baseURI+"sites/yahoo/yahoo.pocket.js",["*://*.yahoo.com/*"],[],!0),safari.extension.addContentScriptFromURL(safari.extension.baseURI+"sites/yahoo/yahoo-share-button.pocket.js",["*://*.yahoo.com/*"],[],!0),safari.extension.addContentStyleSheetFromURL(safari.extension.baseURI+"sites/yahoo/yahoo.pocket.css",["*://*.yahoo.com/*"],[]))}(),{authentication:n}}();